<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando contenido...</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Ajustes espec√≠ficos para la Landing Page */
        .landing-comments-box {
            background: #f9fafb;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #eee;
            text-align: left;
        }

        .landing-comments-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #4b5563;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Hacemos los comentarios un poco m√°s compactos en la landing */
        .landing-comment-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .landing-comment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .landing-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .landing-comment-text {
            font-size: 0.85rem;
            color: #374151;
            margin: 0;
            line-height: 1.4;
        }
        
        .landing-comment-author {
            font-weight: 700;
            font-size: 0.8rem;
            color: #111827;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" id="landing-card">
            <img id="preview-img" src="" alt="" class="article-img" style="display:none;">
            <h1 id="preview-title">Cargando...</h1>
            <p id="preview-desc"></p>
            
            <div id="social-proof-section" style="display:none;">
                
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:10px; font-weight:600; color:#059669;">
                    üëç <span id="landing-likes">0</span> personas recomendaron esto
                </div>

                <div class="landing-comments-box">
                    <div class="landing-comments-title">üí¨ √öltimos comentarios de la comunidad:</div>
                    <div id="landing-comments-list">
                        <p style="font-size:0.8rem; color:#888;">Cargando opiniones...</p>
                    </div>
                </div>
            </div>

            <button class="btn" id="start-btn" onclick="startFlow()">
                üîì DESBLOQUEAR ART√çCULO COMPLETO
            </button>

            <div class="timer-box" id="timer-section">
                <div class="loader"></div>
                <h3>‚è≥ Verificando acceso...</h3>
                <p>Haz clic en el anuncio y espera <strong><span id="countdown">15</span> segundos</strong> para desbloquear el contenido.</p>
                <p style="font-size: 0.8rem; color: #666; margin-top:5px;">No cierres esta pesta√±a.</p>
                
                <div id="final-step" style="display:none; margin-top: 20px; animation: fadeIn 0.5s;">
                    <p style="color:#059669; font-weight: bold; margin-bottom: 10px;">
                        ‚úÖ ¬°Verificaci√≥n exitosa!
                    </p>
                    <button class="btn" onclick="redirectToArticle()" style="background:#059669;">
                        Leer Art√≠culo Ahora ‚ûî
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const articleId = params.get('id');

        // Registrar click (sin esperar respuesta)
        async function trackClick() {
            if (!articleId) return;
            _supabase.rpc('increment_click', { article_id_param: articleId });
        }

        // Cargar datos y prueba social
        async function loadPreview() {
            if(!articleId) return;

            // 1. Datos del art√≠culo y Likes
            const { data: art, error } = await _supabase
                .from('articles')
                .select('title, description, image_url, likes')
                .eq('id', articleId)
                .single();

            if(art) {
                document.getElementById('preview-title').innerText = art.title;
                document.getElementById('preview-desc').innerText = art.description || "Contenido exclusivo...";
                document.getElementById('landing-likes').innerText = art.likes || 0;
                
                if(art.image_url) {
                    const img = document.getElementById('preview-img');
                    img.src = art.image_url;
                    img.style.display = 'block';
                }
                document.title = art.title;
                document.getElementById('social-proof-section').style.display = 'block';
            }

            // 2. Cargar √∫ltimos 3 comentarios (Consulta separada para mayor control)
            const { data: comments } = await _supabase
                .from('comments')
                .select('first_name, last_name, content, avatar_data')
                .eq('article_id', articleId)
                .order('created_at', { ascending: false })
                .limit(3);

            const commentsContainer = document.getElementById('landing-comments-list');
            
            if(comments && comments.length > 0) {
                commentsContainer.innerHTML = comments.map(c => `
                    <div class="landing-comment-item">
                        <img src="${c.avatar_data || 'https://via.placeholder.com/35'}" class="landing-avatar">
                        <div>
                            <div class="landing-comment-author">${c.first_name} ${c.last_name}</div>
                            <p class="landing-comment-text">"${c.content}"</p>
                        </div>
                    </div>
                `).join('');
            } else {
                commentsContainer.innerHTML = '<p style="font-size:0.8rem; color:#666;">S√© el primero en ver esto.</p>';
            }
        }

        // L√≥gica del Timer + Monetizaci√≥n
        function startFlow() {
            trackClick();
            window.open(ADSTERRA_LINK, '_blank');

            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('timer-section').style.display = 'block';

            let timeLeft = 15;
            const timerElement = document.getElementById('countdown');
            
            const interval = setInterval(() => {
                timeLeft--;
                timerElement.innerText = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    // Ocultar contador y mostrar bot√≥n final
                    document.getElementById('timer-section').querySelector('h3').style.display = 'none';
                    document.getElementById('timer-section').querySelector('p').style.display = 'none';
                    document.getElementById('timer-section').querySelector('.loader').style.display = 'none';
                    
                    document.getElementById('final-step').style.display = 'block';
                }
            }, 1000);
        }

        function redirectToArticle() {
            window.location.href = `article.html?id=${articleId}`;
        }

        loadPreview();
    </script>
</body>
</html>
