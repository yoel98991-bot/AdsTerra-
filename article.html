<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art√≠culo</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="card">
            <img id="art-img" src="" alt="" class="article-img" style="display:none;">
            <h1 id="art-title" style="margin-bottom: 0.5rem; color: var(--primary);"></h1>
            <p id="art-date" style="font-size: 0.8rem; color: #888; margin-bottom: 2rem;"></p>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div id="art-content">
                <div class="loader"></div>
            </div>

            <div class="reactions-container">
                <button class="reaction-btn" id="btn-like" onclick="handleVote('like')">
                    üëç <span class="reaction-count" id="count-like">0</span>
                </button>
                <button class="reaction-btn" id="btn-dislike" onclick="handleVote('dislike')">
                    üëé <span class="reaction-count" id="count-dislike">0</span>
                </button>
            </div>
            
            <br>
            <a href="index.html" class="btn" style="background: #333; margin-bottom: 2rem;">Volver al inicio</a>

            <div class="comments-section">
                <h3 style="border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 20px;">
                    üí¨ Comentarios de la comunidad
                </h3>

                <div class="comment-form-box">
                    <h4 style="margin-top:0;">Deja tu opini√≥n</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                        Comparte tu experiencia. Tu foto se optimizar√° autom√°ticamente.
                    </p>
                    
                    <div class="form-row">
                        <input type="text" id="com-name" placeholder="Nombre" required>
                        <input type="text" id="com-lastname" placeholder="Apellido" required>
                    </div>
                    
                    <div class="file-input-wrapper">
                        <label for="com-photo" class="file-custom-label">üì∑ Subir Foto de Perfil</label>
                        <input type="file" id="com-photo" accept="image/*" style="display:none;" onchange="previewImage(this)">
                        <img id="preview-avatar" class="preview-avatar">
                    </div>

                    <textarea id="com-content" rows="3" placeholder="Escribe tu comentario aqu√≠..." required></textarea>
                    
                    <button class="btn" onclick="submitComment()" id="submit-com-btn">Publicar Comentario</button>
                </div>

                <div id="comments-list" class="comment-list">
                    </div>
            </div>

        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const articleId = params.get('id');
        let articleLikes = 0;
        let articleDislikes = 0;

        // --- FUNCIONES PRINCIPALES ---

        async function init() {
            if(!articleId) return;
            
            // 1. Cargar Art√≠culo
            loadArticle();
            
            // 2. Cargar Comentarios y Likes (Paralelo)
            loadReactions();
            loadComments();

            // 3. Registrar vista (sin esperar)
            _supabase.rpc('increment_view', { article_id_param: articleId });
        }

        async function loadArticle() {
            const { data, error } = await _supabase
                .from('articles')
                .select('*')
                .eq('id', articleId)
                .single();

            if(data) {
                document.title = data.title;
                document.getElementById('art-title').innerText = data.title;
                document.getElementById('art-content').innerHTML = data.content; 
                document.getElementById('art-date').innerText = new Date(data.created_at).toLocaleDateString();
                
                if(data.image_url) {
                    const img = document.getElementById('art-img');
                    img.src = data.image_url;
                    img.style.display = 'block';
                }
            }
        }

        // --- L√ìGICA DE REACCIONES (LIKES) ---

        async function loadReactions() {
            const { data } = await _supabase.from('articles').select('likes, dislikes').eq('id', articleId).single();
            if(data) {
                articleLikes = data.likes || 0;
                articleDislikes = data.dislikes || 0;
                updateReactionUI();
            }
            // Verificar si ya vot√≥ en este navegador
            const voted = localStorage.getItem(`voted_${articleId}`);
            if(voted === 'like') document.getElementById('btn-like').classList.add('liked');
            if(voted === 'dislike') document.getElementById('btn-dislike').classList.add('disliked');
        }

        function updateReactionUI() {
            document.getElementById('count-like').innerText = articleLikes;
            document.getElementById('count-dislike').innerText = articleDislikes;
        }

        async function handleVote(type) {
            // Verificar si ya vot√≥ para evitar spam simple
            if(localStorage.getItem(`voted_${articleId}`)) {
                alert("Ya has votado en este art√≠culo.");
                return;
            }

            // Actualizaci√≥n optimista (UI primero)
            if(type === 'like') {
                articleLikes++;
                document.getElementById('btn-like').classList.add('liked');
            } else {
                articleDislikes++;
                document.getElementById('btn-dislike').classList.add('disliked');
            }
            updateReactionUI();
            localStorage.setItem(`voted_${articleId}`, type);

            // Enviar a Supabase
            await _supabase.rpc('increment_vote', { article_id_param: articleId, vote_type: type });
        }

        // --- L√ìGICA DE COMENTARIOS ---

        async function loadComments() {
            const { data, error } = await _supabase
                .from('comments')
                .select('*')
                .eq('article_id', articleId)
                .order('created_at', { ascending: false }); // Los m√°s nuevos primero

            const list = document.getElementById('comments-list');
            list.innerHTML = '';

            if(data && data.length > 0) {
                data.forEach(com => {
                    addCommentToDOM(com);
                });
            } else {
                list.innerHTML = '<p style="text-align:center; color:#999;">S√© el primero en comentar.</p>';
            }
        }

        let avatarBase64 = null; // Variable para guardar la foto procesada

        function previewImage(input) {
            const file = input.files[0];
            if(file) {
                // Procesar y comprimir imagen
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        // Crear canvas para redimensionar (Max 100x100px)
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxSize = 100;
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Guardar como base64 comprimido (JPEG calidad 0.7)
                        avatarBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // Mostrar preview
                        const preview = document.getElementById('preview-avatar');
                        preview.src = avatarBase64;
                        preview.style.display = 'block';
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        async function submitComment() {
            const name = document.getElementById('com-name').value.trim();
            const lastname = document.getElementById('com-lastname').value.trim();
            const content = document.getElementById('com-content').value.trim();

            if(!name || !lastname || !content) {
                alert("Por favor completa todos los campos de texto.");
                return;
            }

            // Usar avatar por defecto si no suben foto
            const finalAvatar = avatarBase64 || "https://ui-avatars.com/api/?name=" + name + "+" + lastname + "&background=random";

            const btn = document.getElementById('submit-com-btn');
            btn.disabled = true;
            btn.innerText = "Publicando...";

            const { data, error } = await _supabase
                .from('comments')
                .insert([{
                    article_id: articleId,
                    first_name: name,
                    last_name: lastname,
                    content: content,
                    avatar_data: finalAvatar
                }])
                .select()
                .single();

            if(error) {
                alert("Error al publicar: " + error.message);
                btn.disabled = false;
                btn.innerText = "Publicar Comentario";
            } else {
                // Limpiar formulario
                document.getElementById('com-name').value = '';
                document.getElementById('com-lastname').value = '';
                document.getElementById('com-content').value = '';
                document.getElementById('com-photo').value = '';
                document.getElementById('preview-avatar').style.display = 'none';
                avatarBase64 = null;
                
                // Si era el primer comentario, limpiar el mensaje de "S√© el primero"
                const list = document.getElementById('comments-list');
                if(list.innerText.includes('S√© el primero')) list.innerHTML = '';

                // Agregar el nuevo comentario arriba
                addCommentToDOM(data, true);

                btn.innerText = "¬°Comentario Publicado!";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "Publicar Comentario";
                }, 2000);
            }
        }

        function addCommentToDOM(comment, isNew = false) {
            const list = document.getElementById('comments-list');
            
            const div = document.createElement('div');
            div.className = 'comment-item';
            
            // Determinar imagen (si es base64 o url)
            const imgBtn = `<img src="${comment.avatar_data || 'https://via.placeholder.com/50'}" class="comment-avatar" alt="User">`;
            
            const dateStr = new Date(comment.created_at).toLocaleDateString();

            div.innerHTML = `
                ${imgBtn}
                <div class="comment-body">
                    <div class="comment-author">
                        <span>${comment.first_name} ${comment.last_name}</span>
                        <span class="comment-date">${dateStr}</span>
                    </div>
                    <p class="comment-text">${comment.content}</p>
                </div>
            `;

            if(isNew) {
                list.prepend(div);
            } else {
                list.appendChild(div);
            }
        }

        // Iniciar todo
        init();
    </script>
</body>
</html>
